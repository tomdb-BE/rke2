set -ex

cd $(dirname $0)/..

source ./scripts/version.sh

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${ETCD_VERSION} \
    --tag ${REPO}/hardened-etcd:${ETCD_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-etcd:${ETCD_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target etcd \
    .

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${COREDNS_VERSION} \
    --tag ${REPO}/hardened-coredns:${COREDNS_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-coredns:${COREDNS_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target coredns \
    .

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${METRICS_SERVER_VERSION} \
    --tag ${REPO}/hardened-k8s-metrics-server:${METRICS_SERVER_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-k8s-metrics-server:${METRICS_SERVER_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target metrics-server \
    .

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${KUBE_PROXY_VERSION} \
    --build-arg MAJOR=${MAJOR} \
    --build-arg MINOR=${MINOR} \
    --build-arg K3S_ROOT_VERSION=${K3S_ROOT_VERSION} \
    --tag ${REPO}/hardened-kube-proxy:${KUBE_PROXY_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-kube-proxy:${KUBE_RPOXY_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target kube-proxy \
    .

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${FLANNEL_VERSION} \
    --build-arg K3S_ROOT_VERSION=${K3S_ROOT_VERSION} \
    --tag ${REPO}/hardened-flannel:${FLANNEL_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-flannel:${FLANNEL_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target flannel \
    .

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg TAG=${CANAL_VERSION} \
    --build-arg CNI_PLUGINS_VERSION=${CNI_PLUGINS_VERSION} \
    --build-arg CALICO_BPFTOOL_VERSION=${CALICO_BPFTOOL_VERSION} \
    --build-arg CALICO_BIRD_VERSION=${CALICO_BIRD_VERSION} \
    --build-arg K3S_ROOT_VERSION=${K3S_ROOT_VERSION} \
    --tag ${REPO}/hardened-calico:${CANAL_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/hardened-calico:${CANAL_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target calico \
    .

#multi arch rebuild docker.io/rancher/nginx-ingress-controller-defaultbackend
DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg ARCH=${GOARCH} \
    --build-arg DEFAULT_BACKEND_TAG=${NGINX_INGRESS_DEFAULT_BACKEND_VERSION%-*} \
    --tag ${REPO}/nginx-ingress-controller-defaultbackend:${NGINX_INGRESS_DEFAULT_BACKEND_VERSION}${IMAGE_BUILD_VERSION} \
    --tag ${REPO}/nginx-ingress-controller-defaultbackend:${NGINX_INGRESS_DEFAULT_BACKEND_VERSION}${IMAGE_BUILD_VERSION}-${GOARCH} \
    --target ingress-default-backend \
    .
