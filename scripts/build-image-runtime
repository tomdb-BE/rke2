#!/usr/bin/env bash
set -ex

cd $(dirname $0)/..

source ./scripts/version.sh

DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg TAG=${VERSION} \
    --build-arg KUBERNETES_VERSION=${KUBERNETES_VERSION} \
    --build-arg MAJOR=${VERSION_MAJOR} \
    --build-arg MINOR=${VERSION_MINOR} \
    --build-arg CACHEBUST="$(date +%s%N)" \
    --build-arg KUBERNETES_IMAGE_TAG=${KUBERNETES_IMAGE_TAG}-${IMAGE_BUILD_VERSION} \
    --build-arg RUNC_VERSION=${RUNC_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CRICTL_VERSION=${CRICTL_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CONTAINERD_VERSION=${CONTAINERD_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg K3S_VERSION=${K3S_VERSION} \
    --build-arg CILIUM_CHART_VERSION=${CILIUM_CHART_VERSION} \
    --build-arg CALICO_CHART_VERSION=${CALICO_CHART_VERSION} \
    --build-arg CALICO_CRD_CHART_VERSION=${CALICO_CRD_CHART_VERSION} \
    --build-arg COREDNS_CHART_VERSION=${COREDNS_CHART_VERSION} \
    --build-arg NGINX_INGRESS_CHART_VERSION=${NGINX_INGRESS_CHART_VERSION} \
    --build-arg KUBE_PROXY_CHART_VERSION=${KUBE_PROXY_CHART_VERSION} \
    --build-arg KUBE_PROXY_CHART_PACKAGE_VERSION=${KUBE_PROXY_CHART_PACKAGE_VERSION} \
    --build-arg METRICS_SERVER_CHART_VERSION=${METRICS_SERVER_CHART_VERSION} \
    --build-arg MULTUS_CHART_VERSION=${MULTUS_CHART_VERSION} \
    --build-arg VSPHERE_CPI_CHART_VERSION=${VSPHERE_CPI_CHART_VERSION} \
    --build-arg VSPHERE_CSI_CHART_VERSION=${VSPHERE_CSI_CHART_VERSION} \
    --build-arg CILIUM_VERSION=${CILIUM_VERSION} \
    --build-arg CILIUM_STARTUP_SCRIPT_VERSION=${CILIUM_STARTUP_SCRIPT_VERSION} \
    --build-arg CANAL_CHART_VERSION=${CANAL_CHART_VERSION} \
    --build-arg CANAL_VERSION=${CALICO_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg FLANNEL_VERSION=${FLANNEL_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CALICO_VERSION=${CALICO_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CALICO_CRD_VERSION=${CALICO_CRD_VERSION} \
    --build-arg COREDNS_VERSION=${COREDNS_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg NGINX_INGRESS_VERSION=${NGINX_INGRESS_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg NGINX_DEFAULT_BACKEND_VERSION=${NGINX_INGRESS_DEFAULT_BACKEND_VERSION} \
    --build-arg KUBE_PROXY_VERSION=${KUBE_PROXY_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg METRICS_SERVER_VERSION=${METRICS_SERVER_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg MULTUS_VERSION=${MULTUS_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CNI_PLUGINS_VERSION=${CNI_PLUGINS_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg VSPHERE_CPI_VERSION=${VSPHERE_CPI_VERSION} \
    --build-arg VSPHERE_CSI_VERSION=${VSPHERE_CSI_VERSION} \
    --build-arg REPO=${REPO} \
    --tag ${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION} \
    --tag ${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-${GOOS}-${GOARCH} \
    --target runtime \
    --file Dockerfile \
    .

if [ "${ARCH}" = "amd64" ]; then
DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} docker image build \
    --build-arg TAG=${VERSION} \
    --build-arg KUBERNETES_VERSION=${KUBERNETES_VERSION} \
    --build-arg MAJOR=${VERSION_MAJOR} \
    --build-arg MINOR=${VERSION_MINOR} \
    --build-arg KUBERNETES_IMAGE_TAG=${KUBERNETES_IMAGE_TAG}-${IMAGE_BUILD_VERSION} \
    --build-arg K3S_VERSION=${K3S_VERSION} \
    --build-arg RUNC_VERSION=${RUNC_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CRICTL_VERSION=${CRICTL_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg CONTAINERD_VERSION=${CONTAINERD_VERSION}-${IMAGE_BUILD_VERSION} \
    --build-arg REPO=${REPO} \
    --build-arg CACHEBUST="$(date +%s%N)" \
    --tag ${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-windows-amd64 \
    --target windows-runtime \
    --file Dockerfile.windows \
    .
fi

mkdir -p build/images
docker image save \
    --output build/images/${PROG}-runtime.tar \
    ${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-${GOOS}-${GOARCH}
